# 手牌パターンの拡張仕様

このドキュメントでは、mj-tilesライブラリで採用する拡張記法の仕様を定義します。

## 採用する記法システム

Web調査の結果、以下の2つの記法システムを採用します：

1. **新篠ゆう方式（MPSZ拡張表記案）** - 副露の方向性を記号で表現
2. **牌画作成くん方式** - コンパクトな修飾子による状態表現

## 1. 新篠ゆう方式（MPSZ拡張表記案）

出典: [【MPSZ拡張表記案】麻雀のMPSZ表記の拡張を考えてみる](https://note.com/yuarasino/n/n1ba95bf3b618)

### 基本概念

MPSZ形式（`123m456p789s`）を拡張し、副露（鳴き）の情報を記号で表現します。

### 副露の記号定義

| 記号 | 意味 | 用途 |
|------|------|------|
| `-` | チー・ポン・大明槓 | 明示的な副露 |
| `=` | 加槓 | ポン後の追加 |
| `+` | 暗槓 | 自分でツモった4枚 |

### 鳴きの方向性表現

記号を挿入する位置で、どこから鳴いたかを表現します：

- **上家（カミチャ）から**: 1つ目の数字の後に記号
- **対面（トイメン）から**: 2つ目の数字の後に記号
- **下家（シモチャ）から**: 3つ目の数字の後に記号
- **暗槓**: 4つ目の数字の後に記号

### 具体例

#### チー（順子）

```
2-13m   → 二萬・一萬・三萬（一萬を上家から鳴き）
12-3m   → 一萬・二萬・三萬（二萬を対面から鳴き）
123-m   → 一萬・二萬・三萬（三萬を下家から鳴き）
```

#### ポン（刻子）

```
5-55p   → 五筒・五筒・五筒（1枚目を上家から鳴き）
55-5p   → 五筒・五筒・五筒（2枚目を対面から鳴き）
555-p   → 五筒・五筒・五筒（3枚目を下家から鳴き）
```

#### 大明槓（ミンカン）

```
4-444s  → 四索・四索・四索・四索（1枚目を上家から鳴き）
44-44s  → 四索・四索・四索・四索（2枚目を対面から鳴き）
444-4s  → 四索・四索・四索・四索（3枚目を下家から鳴き）
```

#### 加槓（カカン）

```
5-55=0p  → 五筒・五筒・五筒・赤五筒（上家からポン後に加槓）
55-5=0p  → 五筒・五筒・五筒・赤五筒（対面からポン後に加槓）
```

**記法ルール**:
- `-` 記号の位置: 元のポンでどこから鳴いたか
- `=` 記号の位置: 加槓で追加した牌（常に最後の数字）

#### 暗槓（アンカン）

```
1111+z  → 東・東・東・東（暗槓）
5555+m  → 五萬・五萬・五萬・五萬（暗槓）
```

**記法ルール**:
- `+` 記号の位置: 常に最後（4枚全て記述）
- 最後の数字: 最後にツモってきた牌

### ツモ・ロン牌の表現

- **最後に種類記号を省略せずに記述**することでツモ/ロンを表現
- 例: `3456s3s` → 三四五六索で三索をツモ

### 実装上の注意点

1. **パース順序**: 左から右へ1文字ずつ処理
2. **記号の検出**: `-`, `=`, `+` を検出したら副露として処理
3. **方向性の判定**: 記号の位置（何番目の数字の後か）で判定
4. **赤ドラの扱い**: `r5m` または `0m` 記法との併用

---

## 2. 牌画作成くん方式

出典: [牌画作成くん byその研](https://mahjong-manage.com/paiga/paiga1.php)

### 基本概念

コンパクトな修飾子を牌の前後に付与することで、様々な状態を表現します。

### 基本記法

#### 数牌

- 萬子: `○m` (例: `5m` = 五萬)
- 筒子: `○p` (例: `3p` = 三筒)
- 索子: `○s` (例: `7s` = 七索)

#### 字牌（独自記号）

| 記号 | 牌 |
|------|-----|
| `t` | 東 |
| `n` | 南 |
| `s` | 西 |
| `p` | 北 |
| `h` | 白 |
| `r` | 發 |
| `c` | 中 |

### 修飾子定義

#### 前置修飾子（牌の前に付ける）

| 記号 | 意味 | 説明 |
|------|------|------|
| `y` | 横向き | 立直宣言牌・副露牌 |
| `a` | 赤ドラ | 赤五萬・赤五筒・赤五索 |
| `g` | ツモ切り | 自動的に捨てられた牌 |
| `o` | 表（背面） | 伏せられた牌（暗槓など） |

#### 後置修飾子（牌の後に付ける）

| 記号 | 意味 | 説明 |
|------|------|------|
| `m` | ツモ牌 | 自摸した牌 |
| `l` | ロン牌 | 他家から和了した牌 |
| `d` | ドラ | ドラ表示牌 |

#### その他

- **半角スペース**: 牌の区切り・空白
- **`j`（行頭）**: 捨て牌列（河）の開始マーカー

### 複合表現の例

#### 赤5pをツモ切りで立直

```
gya5p
```

解説:
- `g`: ツモ切り
- `y`: 横向き（立直）
- `a`: 赤ドラ
- `5p`: 五筒

#### 8pで大明槓

```
88py88p
```

解説:
- `88p`: 八筒2枚
- `y`: 横向き（鳴いた牌）
- `88p`: 八筒2枚

#### 3sの暗槓

```
o33so
```

解説:
- `o`: 伏せ牌（最初と最後）
- `33s`: 三索2枚（見える部分）

**新篠ゆう方式との違い**:
- 新篠ゆう方式: 4枚全て記述（`3333+s`）
- 牌画作成くん方式: 見える2枚のみ記述（`o33so`）
- 内部的にはどちらも4枚の暗槓として扱われる

#### チー（順子）の表現

```
78y9p
```

解説:
- `78`: 七八
- `y`: 横向き（鳴いた牌）
- `9p`: 九筒

#### ポン（刻子）の表現

```
5y55p   → 1枚目を上家から鳴き
55y5p   → 2枚目を対面から鳴き
555yp   → 3枚目を下家から鳴き
```

解説:
- 横向き牌の位置で鳴きの方向を表現
- 3枚の刻子のうち1枚が横向き

#### 加槓の表現

```
55y55p
```

解説:
- 元々 `55y5p`（対面からポン）の状態から4枚目を追加
- 横向き牌の位置を保持することで、誰からポンしたかの情報が残る
- 3枚→4枚に増えることで加槓を表現

#### 捨て牌列（河）

```
jptg1ss9p9m9m2py6p
```

解説:
- `j`: 捨て牌列モード
- 以降の牌が河に並ぶ
- `g`: ツモ切り
- `y`: 横向き（立直宣言牌）

### 実装上の注意点

1. **修飾子の順序**: 前置修飾子は順不同（`gya5p` = `gay5p` = `ayg5p`）
2. **字牌の記号**: 標準MPSZ（`1z` = 東）とは異なる独自記号を使用
3. **空白の扱い**: 半角スペースで牌を明示的に区切る
4. **捨て牌モード**: `j` で始まる行は特別な処理
5. **加槓の判定**: 3枚（ポン）か4枚（カン）かで判定、横向き位置で鳴きの方向を特定
6. **字牌独自記号の衝突解決**:
   - `r`, `p`, `s` は既存の記法と衝突する可能性がある
   - **解決ルール**:
     - 数字の直後の `m`, `p`, `s`: 数牌として解釈（例: `3p` = 三筒）
     - `r` + 数字 + `m`/`p`/`s`: 赤ドラとして解釈（例: `r5m` = 赤五萬）
     - 単独またはスペース区切りの `t`, `n`, `s`, `p`, `h`, `r`, `c`: 字牌として解釈（例: `t n s p` = 東南西北）
     - 前置修飾子の後の独自記号: 字牌として解釈（例: `yr` = 横向きの發）

---

## 統合方針

### パーサーの拡張

現在のパーサー（`parser.ts`）を拡張し、以下の2つの記法を解釈できるようにします：

1. **新篠ゆう方式**: `-`, `=`, `+` を検出して副露情報を抽出
2. **牌画作成くん方式**: `y`, `a`, `g`, `o`, `m`, `l`, `d` を検出して状態情報を抽出

### データ構造の拡張

**設計方針**: 内部表現はmspz拡張方式（新篠ゆう方式）に統一し、牌画作成くん方式は入力時に変換する。

```typescript
// 現在: TileCode = "1m" | "2m" | ... | "7z" | "0m" | "0p" | "0s"

// 拡張後
type TileState = {
  code: TileCode;         // "1m" | "2m" | ... | "7z" | "0m" | "0p" | "0s"
  // 牌の状態（表示用）
  isRotated?: boolean;    // y: 横向き（副露牌・立直宣言牌）
  isFaceDown?: boolean;   // o: 伏せ牌（暗槓）
  isTsumo?: boolean;      // m: ツモ牌
  isRon?: boolean;        // l: ロン牌
  // 注: 赤ドラは code = "0m" | "0p" | "0s" で表現（isRed フラグは不要）
  // 注: 牌画作成くん方式の "a5m" は内部的に "0m" に変換される
};

type MeldInfo = {
  type: 'chii' | 'pon' | 'daiminkan' | 'kakan' | 'ankan';
  tiles: TileState[];
  // 鳴きの情報（mspz拡張方式ベース）
  from?: 'kamicha' | 'toimen' | 'shimocha'; // 鳴きの方向（暗槓は undefined）
  calledTileIndex?: number; // 鳴いた牌の位置（0始まり）
};

type Hand = {
  concealed: TileState[]; // 門前牌
  melds: MeldInfo[];      // 副露面子
};
```

**設計の特徴**:
- 赤ドラは `code` で表現（`"0m"`, `"0p"`, `"0s"`）、専用フラグは不要
- 方向情報は明示的に `from` フィールドで保持（推測不要）
- 牌画作成くん方式の入力は正規化時に mspz 拡張方式に変換

### レンダリングの対応

#### 新篠ゆう方式

- 副露面子をグループ化して表示
- 鳴いた牌を横向きに回転（CSS transform）
- 面子間に適切な間隔を配置

#### 牌画作成くん方式

- 各修飾子に対応するCSSクラスを適用
- 横向き: `class="tile rotated"`
- ツモ切り: `class="tile tsumogiri"`
- 伏せ牌: 裏面SVGを使用

### 互換性の維持

- **既存の基本記法**: `123m456p789s` は引き続きサポート
- **赤ドラ記法**: `0m` と `am5` の両方をサポート（内部的に統一）
- **段階的な実装**: 基本機能から順次対応

---

## 実装優先度

### Phase 1: 基本的な副露表現（新篠ゆう方式）

- [ ] `-` 記号によるチー・ポン・カンの解釈
- [ ] 方向性（上家・対面・下家）の判定
- [ ] 副露面子のグループ化

### Phase 2: 状態修飾子（牌画作成くん方式）

- [ ] `y` 横向き（副露牌）
- [ ] `a` 赤ドラ（既存の`0m`記法との統合）
- [ ] `m`, `l` ツモ牌・ロン牌

### Phase 3: 高度な表現

- [ ] `g` ツモ切り
- [ ] `o` 伏せ牌（暗槓）
- [ ] `j` 捨て牌列モード
- [ ] `=`, `+` 加槓・暗槓の区別

### Phase 4: 統合とテスト

- [ ] 両記法の組み合わせテスト
- [ ] 複雑な手牌パターンの検証
- [ ] ドキュメントとサンプルの整備

---

## 参考資料

- [MPSZ拡張表記案 - 新篠ゆう](https://note.com/yuarasino/n/n1ba95bf3b618)
- [牌画作成くん byその研](https://mahjong-manage.com/paiga/paiga1.php)
- [kobalab/majiang-core Wiki - 牌姿](https://github.com/kobalab/majiang-core/wiki/牌姿)
- [mahjong-tex LaTeX Package](https://github.com/Schmytzi/mahjong-tex)
- [What is the MPSZ format?](https://iroiro.dev/en/product/tips/mpsz.html)
